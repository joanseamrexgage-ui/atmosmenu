import telegram
from telegram import Update, WebAppInfo
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes
import threading
from flask import Flask
import logging
import os

# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç—ã–≤–∞–µ—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ "Environment Variables" –Ω–∞ Render
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
MINI_APP_URL = os.environ.get("MINI_APP_URL")


# --- Flask Web Server –¥–ª—è "Keep-Alive" ---
# –≠—Ç–æ—Ç –º–∏–Ω–∏-—Å–µ—Ä–≤–µ—Ä –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —Ö–æ—Å—Ç–∏–Ω–≥ –Ω–µ "—É—Å—ã–ø–ª—è–ª" –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞
app = Flask(__name__)

@app.route('/')
def hello_world():
    """–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –ø–æ —Å—Å—ã–ª–∫–µ –æ—Ç —Ö–æ—Å—Ç–∏–Ω–≥–∞.
    –û–Ω–∞ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å Uptime Robot –º–æ–≥ –µ–µ "–ø–∏–Ω–≥–æ–≤–∞—Ç—å".
    """
    return 'Bot is alive!'

def run_flask():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä."""
    # 0.0.0.0 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
    # port=10000 - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç –¥–ª—è –º–Ω–æ–≥–∏—Ö —Ö–æ—Å—Ç–∏–Ω–≥–æ–≤
    app.run(host='0.0.0.0', port=10000)


# --- –õ–æ–≥–∏–∫–∞ Telegram –ë–æ—Ç–∞ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Mini App."""
    keyboard = [
        [telegram.KeyboardButton(
            "–û—Ç–∫—Ä—ã—Ç—å –∫—É–ª–∏–Ω–∞—Ä–Ω—É—é –∫–Ω–∏–≥—É üìñ",
            web_app=WebAppInfo(url=MINI_APP_URL)
        )]
    ]
    reply_markup = telegram.ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫—É–ª–∏–Ω–∞—Ä–Ω—É—é –∫–Ω–∏–≥—É! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Ä–µ—Ü–µ–ø—Ç–æ–≤.",
        reply_markup=reply_markup
    )


# --- –û—Å–Ω–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ---
if __name__ == '__main__':
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if not TELEGRAM_TOKEN or not MINI_APP_URL:
        print("!!! –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_TOKEN –∏ MINI_APP_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ! !!!")
        print("!!! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 'Environment' –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ Render.com !!!")
    else:
        # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
        flask_thread = threading.Thread(target=run_flask)
        flask_thread.start()

        # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Telegram –±–æ—Ç–∞
        application = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
        application.add_handler(CommandHandler("start", start))

        print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...")
        application.run_polling()

